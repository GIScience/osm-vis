'use strict';var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();var width=window.innerWidth;var height=window.innerHeight;var labelWidth=120;var animationDuration=300;var animationDelay=100;var animationEventDelay=450;var animationEventHold=600;var angle=function angle(x,y){return Math.atan(y/x)+(x<0?Math.PI:0);};var length=function length(x,y){return Math.sqrt(x*x+y*y);};$(document).ready(function(){d3.json('../data/osm-tags-history-wiki.json',function(dataset){var data=R.map(function(d){d.history=R.map(function(h){return[moment(h[0]),h[1]];},d.history);return d;},dataset.descriptionHistory);var dates=R.compose(R.flatten,R.map(function(d){return R.map(function(ts){return ts[0];},d.history);}))(data);var datesMin=moment.min(dates);var datesMax=moment.max(dates);var prepareDataForTree=function prepareDataForTree(dat){var dataTreeTmp=R.compose(R.map(function(d){d.id=d.key+'======'+d.value;d.parentId=d.key;return d;}),R.filter(R.complement(R.propEq('value','*'))))(dat);var keys=R.compose(R.uniq(),R.map(R.prop('key')))(dat);dataTreeTmp=dataTreeTmp.concat(R.map(function(k){return{id:k,parentId:'===root===',key:k};},keys));return dataTreeTmp.concat([{id:'===root===',parentId:null}]);};var svgParent=pageFixed(width,height,0,0).attr('transform','translate('+width/2+', '+height/2+')');var svg=svgParent.append('g');svgParent.append('g').classed('svg-hover',true);var svgAngle=0;var computeAngle=function computeAngle(){var box=d3.select('.svg').select('svg').node().getBoundingClientRect();var centerX=d3.event.x-box.left-box.width/2;var centerY=d3.event.y-box.top-box.height/2;return angle(centerX,centerY)/(2*Math.PI)*180;};var rotateStart=function rotateStart(){svgAngle-=computeAngle();};var rotate=function rotate(){var a=computeAngle();svgParent.attr('transform','translate('+width/2+', '+height/2+') rotate('+(svgAngle+a)+')');};var rotateEnd=function rotateEnd(){svgAngle+=computeAngle();};d3.select('.svg').call(d3.drag().on('start',rotateStart).on('drag',rotate).on('end',rotateEnd));var stratify=d3.stratify().id(function(d){return d.id;}).parentId(function(d){return d.parentId;});var tree=d3.tree().size([360,Math.min(width,height)/2-labelWidth]).separation(function(a,b){return(a.parent==b.parent?1:2)/a.depth;});var project=function project(a,radius){return[radius*Math.cos((a-90)/180*Math.PI),radius*Math.sin((a-90)/180*Math.PI)];};var lastRedraw=null;var redraw=function redraw(m){var dataTree=prepareDataForTree(R.filter(function(d){return R.any(function(h){return h[0].isSameOrBefore(m);},d.history)&&R.all(function(h){return h[0].isAfter(m)||h[1]>0;},d.history);},data));var root=tree(stratify(R.sortBy(R.prop('id'),dataTree)));var timeScaling=function timeScaling(d,x){return d.data.history===undefined?x:d3.zoomIdentity.scale(d3.scaleLinear().domain([1,1+datesMax.diff(datesMin)]).range([.6,2.6])(1+m.diff(d.data.history[0][0]))).apply(x);};var hoverNode=function hoverNode(node){$('.edge[data-id="'+$(node).data('id')+'"]').clone().appendTo('.svg-hover');var hoveredNode=$(node).clone().appendTo('.svg-hover');var circle=$(hoveredNode).find('circle').attr('r',5);$(circle).clone().addClass('background').insertBefore($(hoveredNode).find('text'));$(hoveredNode).on('mouseout',function(){return $('.svg-hover').children().remove();});};var computePath=function computePath(d){var _timeScaling=timeScaling(d,project(d.x,d.y)),_timeScaling2=_slicedToArray(_timeScaling,2),x=_timeScaling2[0],y=_timeScaling2[1];var _project=project(d.parent.x,d.parent.y),_project2=_slicedToArray(_project,2),parentX=_project2[0],parentY=_project2[1];var a=(angle(parentX,parentY)+2*Math.PI)%(2*Math.PI);var b=(angle(x-parentX,y-parentY)+2*Math.PI)%(2*Math.PI);var angleDiff=(b-a+5*Math.PI)%(2*Math.PI)-Math.PI;var angleDiffSqrt=Math.sign(angleDiff)*Math.sqrt(Math.abs(angleDiff));var distToParent=length(x-parentX,y-parentY);var parentLength=length(parentX,parentY);var k=angleDiffSqrt*distToParent/Math.min(window.width,window.height)*160/parentLength;var dParentX=parentX-k*parentY;var dParentY=parentY+k*parentX;return'M'+x+' '+y+' C'+x+' '+y+', '+dParentX+' '+dParentY+', '+parentX+' '+parentY;};var computeOpacity=function computeOpacity(d){var _timeScaling3=timeScaling(d,project(d.x,d.y)),_timeScaling4=_slicedToArray(_timeScaling3,2),x=_timeScaling4[0],y=_timeScaling4[1];var _project3=project(d.parent.x,d.parent.y),_project4=_slicedToArray(_project3,2),parentX=_project4[0],parentY=_project4[1];return .1+1/length(x-parentX,y-parentY)*Math.min(window.width,window.height)/15;};var edge=svg.selectAll('.edge').data(R.filter(function(d){return d.data.key!==undefined&&d.data.value!==undefined;},root.descendants()),function(d){return d.data.id;});edge.enter().append('path').style('opacity',0).attr('data-id',function(d){return d.id;}).classed('edge',true).attr('d',computePath);edge.exit().remove();d3.timeout(function(){svg.selectAll('.edge').style('opacity',computeOpacity);},animationDuration+2*animationDelay);d3.timeout(function(){svg.selectAll('.edge').transition().duration(animationDuration).attr('d',computePath,animationDelay).style('opacity',computeOpacity);});var node=svg.selectAll('.node').data(R.filter(function(d){return d.data.key!==undefined;},root.descendants()),function(d){return d.data.id;});var nodeG=node.enter().append('g').style('opacity',0).attr('data-id',function(d){return d.id;}).classed('node',true).classed('node-internal',function(d){return d.children;}).classed('node-leaf',function(d){return!d.children;}).classed('event',function(d){return d.data.value!==undefined&&R.any(function(h){return h[0].isAfter(lastRedraw)&&h[0].isSameOrBefore(m)||h[0].isAfter(m)&&h[0].isSameOrBefore(lastRedraw);},d.data.history);}).attr('transform',function(d){return'translate('+timeScaling(d,project(d.x,d.y))+')';});nodeG.append('text').text(function(d){return d.data.value?d.data.value:d.data.key;}).attr('dy','.31em').attr('x',function(d){return!d.children?6:-6;}).style('text-anchor',function(d){return!d.children?'start':'end';}).attr('transform',function(d){return'rotate('+(d.x-90)+')';}).on('mouseover',function(){hoverNode($(this).parent());});nodeG.append('circle').attr('r',2.5).on('mouseover',function(){hoverNode($(this).parent());});node.exit().remove();d3.timeout(function(){svg.selectAll('.node').style('opacity',1);},animationDuration+2*animationDelay);d3.timeout(function(){svg.selectAll('.node').transition().duration(animationDuration).attr('transform',function(d){return'translate('+timeScaling(d,project(d.x,d.y))+')';});svg.selectAll('.node').select('text').transition().duration(animationDuration).attr('x',function(d){return!d.children?6:-6;}).style('text-anchor',function(d){return!d.children?'start':'end';}).attr('transform',function(d){return'rotate('+(d.x-90)+')';});},animationDelay);svg.selectAll('.event').classed('event',false).select('circle').transition().delay(animationEventDelay).duration(animationEventHold).attr('r',5).transition().delay(1.3*animationEventHold).duration(animationEventHold).attr('r',2.5);lastRedraw=m;};new SliderTime({min:datesMin,max:datesMax,fromFraction:[2,1],callback:redraw,width:.8*Math.min(width,height),playingHide:false,playingSpeed:1250,playingFrameRate:300});initPage({infoDescription:'The core tags, which are used in OSM to descripe nodes, ways, and relations, are documented in the <a href="https://wiki.openstreetmap.org/wiki/Map_Features" target="_blank">OSM wiki</a>. This documentation serves as an ontology but there is no obligation to not use other tags. This visualization explores how the documented tags, i.e., keys and values, have developed over time.',infoIdea:[alexanderZipf,franzBenjaminMocnik],infoProgramming:[franzBenjaminMocnik],infoData:[dataset],infoLibraries:libsDefault.concat([libIonRangeSlider]),init:function init(){initTooltip({selector:'.node-internal:first',text:'The keys are depicted in the inner circle'});initTooltip({selector:'.node-leaf:first',text:'The values are depicted in the outer circle'});initTooltip({selector:'.node:eq('+Math.round($('.node').length/2)+')',text:'Drag to rotate'});initTooltip({selector:'.irs-slider',text:'Drag to change the point in time',positionMy:'bottom left',positionAt:'top center'});initTooltip({selector:'.timesliderPlaying',text:'Click here to animate time',positionMy:'bottom right',positionAt:'top right'});}});});});